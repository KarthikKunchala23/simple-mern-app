name: build MernAppWorkflow
on: push
jobs:
    build:
        runs-on: ubuntu-latest

        services:
          mongo:
            image: mongo:latest
            ports:
              - 27017:27017  # Expose MongoDB on port 27017
            # options:  --health-interval=10s --health-timeout=5s --health-retries=5

        steps:
            - name: Get code
              uses: actions/checkout@v4

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 18

            - name: Install dependencies
              run: npm ci

            - name: install mongo
              run: npm install mongoose
            #   working-directory: ./simple-mern-app

            - name: change to backend
              run: npm install
              working-directory: ./backend

            - name: Wait for MongoDB to be ready
              run: |
                until nc -zv localhost 27017; do
                  echo "Waiting for MongoDB to start..."
                  sleep 1
                done

            - name: Install ngrok
              run: curl -s https://ngrok.com/download | tar xz && sudo mv ngrok /usr/local/bin
              
            - name: Start ngrok
              run: ngrok http 5000 &

            - name: Start the application
              run: |
                nohup node server.js &  # Start the app in the background
      
            # Wait for 5 minutes (300 seconds)
            - name: Wait for 5 minutes
              run: sleep 300  # This will sleep for 5 minutes
      
            # Stop the application (find the process and kill it)
            - name: Stop the application
              run: |
                # Find the process ID (PID) for Node.js and kill it
                pid=$(ps aux | grep 'node server.js' | awk '{print $2}')
                if [ ! -z "$pid" ]; then
                  kill $pid  # Stop the application
                  echo "Application stopped"
                fi

              




